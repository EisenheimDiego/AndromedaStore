name: C18780

on:
  push:
    branches: [ "C18780" ]
  pull_request:
    branches: [ "C18780" ]

jobs:
  build:
    runs-on: ubuntu-latest

    services:
      mysql:
        image: mysql:latest
        ports:
          - 3306:3306
        options: >-
          --health-cmd="mysqladmin ping --silent"
          --health-interval=10s
          --health-timeout=5s
          --health-retries=3
        env:
          MYSQL_ROOT_PASSWORD: 123456

    steps:
    - uses: actions/checkout@v4

    - name: Wait for MySQL to be healthy
      run: |
        echo "Waiting for MySQL to be healthy..."
        while ! docker inspect --format '{{json .State.Health.Status}}' $(docker ps -q --filter ancestor=mysql:latest) | grep -q '"healthy"'; do
          echo "Waiting for MySQL..."
          sleep 5
        done
        echo "MySQL is healthy."

    - name: Setup .NET
      uses: actions/setup-dotnet@v4
      with:
        dotnet-version: 8.0.x

    - name: Restore dependencies
      run: |
        cd C18780/backend
        dotnet restore

    - name: Build
      run: |
        cd C18780/backend
        dotnet build --no-restore

    - name: Test
      run: |
        cd C18780/backend
        dotnet test --no-build --verbosity normal
